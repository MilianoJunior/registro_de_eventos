# Implementa√ß√£o do Campo "Requer A√ß√£o"

## ‚úÖ Implementa√ß√£o Completa

### üìä Resumo das Altera√ß√µes

**Data:** 14/10/2025  
**Status:** ‚úÖ Implementado e Pronto para Testes  
**Campo:** `requer_acao` (armazenado em `metadata` JSON)

---

## üéØ O Que Foi Implementado

### **1. Frontend - Formul√°rio HTML** ‚úÖ

**Arquivo:** `libs/views/registro_eventos.html`

**Altera√ß√µes:**
- ‚úÖ Adicionado checkbox "Requer A√ß√£o Urgente" com destaque visual (borda amarela)
- ‚úÖ √çcone de warning e descri√ß√£o explicativa
- ‚úÖ Design responsivo e acess√≠vel
- ‚úÖ Localizado ap√≥s os campos Severidade e Playbook

**C√≥digo:**
```html
<!-- Campo Requer A√ß√£o -->
<div class="mt-4 p-4 rounded-lg border-2 border-warning/30 bg-warning/5">
    <label class="flex items-start gap-3 cursor-pointer group">
        <input type="checkbox" id="requer_acao" name="requer_acao" 
               class="mt-1 w-5 h-5 rounded border-warning/50 text-warning focus:ring-warning focus:ring-2">
        <div class="flex-1">
            <div class="flex items-center gap-2">
                <span class="material-icons text-warning text-lg">warning</span>
                <span class="text-sm font-semibold text-text-primary group-hover:text-warning transition">
                    Requer A√ß√£o Urgente
                </span>
            </div>
            <p class="text-xs text-text-muted mt-1.5 leading-relaxed">
                Marque se esta ocorr√™ncia necessita de aten√ß√£o imediata da equipe. 
                Operadores ser√£o notificados e um bot√£o de a√ß√£o aparecer√° nas listagens.
            </p>
        </div>
    </label>
</div>
```

---

### **2. Frontend - JavaScript** ‚úÖ

**Arquivo:** `libs/views/registro_eventos.html`

**Altera√ß√µes:**
- ‚úÖ Captura do valor do checkbox (`.checked`)
- ‚úÖ Adicionado ao payload JSON enviado para API
- ‚úÖ Valida√ß√£o autom√°tica (boolean)

**C√≥digo:**
```javascript
const formData = {
    // ... campos existentes ...
    requer_acao: document.getElementById('requer_acao').checked  // ‚Üê NOVO
};
```

---

### **3. Backend - Controller** ‚úÖ

**Arquivo:** `libs/controllers/eventosController.py`

**Altera√ß√µes:**
- ‚úÖ Import de `json` e `datetime`
- ‚úÖ Constru√ß√£o do objeto `metadata` JSON
- ‚úÖ Salvamento no campo `metadata` da tabela
- ‚úÖ Estrutura extens√≠vel para futuras funcionalidades

**C√≥digo:**
```python
# Constr√≥i metadata JSON
requer_acao = data.get("requer_acao", False)
metadata = {
    "requer_acao": requer_acao,
    "notificado_em": None,
    "responsavel_id": None,
    "assumido_em": None,
    "observacoes": None
}

# Prepara dados para inser√ß√£o
ocorrencia_data = {
    # ... campos existentes ...
    "metadata": json.dumps(metadata)  # ‚Üê NOVO
}
```

---

### **4. Visualiza√ß√£o - Badge "REQUER A√á√ÉO"** ‚úÖ

**Arquivo:** `libs/views/usinas.html`

**Altera√ß√µes:**
- ‚úÖ Badge vermelho destacado com √≠cone de warning
- ‚úÖ Aparece automaticamente quando `metadata.requer_acao == True`
- ‚úÖ Integrado com os badges de Status e Severidade
- ‚úÖ Responsive (flex-wrap)

**C√≥digo:**
```html
{# Badge Requer A√ß√£o #}
{% if alarme.metadata %}
    {% set metadata_dict = alarme.metadata if alarme.metadata is mapping else {} %}
    {% if metadata_dict.get('requer_acao') %}
        <span class="px-2 py-0.5 bg-danger/10 text-danger text-xs rounded whitespace-nowrap font-semibold flex items-center gap-1">
            <span class="material-icons text-xs">warning</span>
            REQUER A√á√ÉO
        </span>
    {% endif %}
{% endif %}
```

---

### **5. Bot√£o "Assumir Responsabilidade"** ‚úÖ

**Arquivo:** `libs/views/usinas.html`

**Altera√ß√µes:**
- ‚úÖ Bot√£o vermelho destaque ao lado do bot√£o "Resolver"
- ‚úÖ Aparece apenas quando `requer_acao=True` e n√£o h√° respons√°vel
- ‚úÖ √çcone `assignment_ind` (pessoa)
- ‚úÖ Chama fun√ß√£o JavaScript `assumirResponsabilidade(id)`

**C√≥digo:**
```html
{# Bot√£o Assumir Responsabilidade #}
{% if metadata_dict.get('requer_acao') and not metadata_dict.get('responsavel_id') %}
    <button onclick="assumirResponsabilidade({{ alarme.id }})" 
            class="px-3 py-1.5 rounded-lg bg-danger text-white text-xs font-medium hover:opacity-90 transition flex items-center gap-1">
        <span class="material-icons text-xs">assignment_ind</span>
        Assumir Responsabilidade
    </button>
{% endif %}
```

---

### **6. Decodifica√ß√£o de Metadata JSON** ‚úÖ

**Arquivo:** `libs/controllers/usinasController.py`

**Altera√ß√µes:**
- ‚úÖ Import de `json`
- ‚úÖ M√©todo auxiliar `_decode_metadata()`
- ‚úÖ Decodifica automaticamente strings JSON para dict
- ‚úÖ Aplicado tanto em modo DEVELOPER quanto modo real

**C√≥digo:**
```python
def _decode_metadata(self, ocorrencias):
    """Decodifica o campo metadata JSON para cada ocorr√™ncia"""
    for ocorrencia in ocorrencias:
        if ocorrencia.get('metadata'):
            try:
                if isinstance(ocorrencia['metadata'], str):
                    ocorrencia['metadata'] = json.loads(ocorrencia['metadata'])
            except (json.JSONDecodeError, TypeError):
                ocorrencia['metadata'] = {}
        else:
            ocorrencia['metadata'] = {}
    return ocorrencias
```

---

### **7. JavaScript - Fun√ß√£o de Assumir Responsabilidade** ‚úÖ

**Arquivo:** `libs/views/usinas.html`

**Altera√ß√µes:**
- ‚úÖ Fun√ß√£o async `assumirResponsabilidade(ocorrenciaId)`
- ‚úÖ Confirma√ß√£o via `confirm()`
- ‚úÖ Chamada POST para API `/api/ocorrencias/{id}/assumir`
- ‚úÖ Reload da p√°gina ap√≥s sucesso
- ‚úÖ Tratamento de erros

**C√≥digo:**
```javascript
async function assumirResponsabilidade(ocorrenciaId) {
    if (!confirm('Deseja assumir a responsabilidade por esta ocorr√™ncia?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/ocorrencias/${ocorrenciaId}/assumir`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Responsabilidade assumida com sucesso!');
            window.location.reload();
        } else {
            alert('Erro ao assumir responsabilidade: ' + (result.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao assumir responsabilidade. Tente novamente.');
    }
}
```

---

## üìä Estrutura do Metadata JSON

### **Formato Atual:**

```json
{
  "requer_acao": true,
  "notificado_em": null,
  "responsavel_id": null,
  "assumido_em": null,
  "observacoes": null
}
```

### **Campos:**

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `requer_acao` | `boolean` | Se a ocorr√™ncia requer a√ß√£o urgente |
| `notificado_em` | `string/null` | Timestamp da notifica√ß√£o |
| `responsavel_id` | `int/null` | ID do usu√°rio respons√°vel |
| `assumido_em` | `string/null` | Timestamp quando foi assumido |
| `observacoes` | `string/null` | Observa√ß√µes adicionais |

---

## üß™ Como Testar

### **1. Registrar Nova Ocorr√™ncia com "Requer A√ß√£o"**

1. Acesse: `http://localhost:5000/registro_eventos`
2. Preencha todos os campos obrigat√≥rios
3. ‚úÖ **Marque** o checkbox "Requer A√ß√£o Urgente"
4. Clique em "Registrar Ocorr√™ncia"
5. Verifique se aparece mensagem de sucesso

**SQL para verificar:**
```sql
SELECT id, tipo, descricao, metadata, created_at 
FROM op_ocorrencia 
ORDER BY id DESC 
LIMIT 1;
```

**Resultado esperado no metadata:**
```json
{"requer_acao": true, "notificado_em": null, "responsavel_id": null, "assumido_em": null, "observacoes": null}
```

---

### **2. Visualizar Badge "REQUER A√á√ÉO"**

1. Acesse uma p√°gina de usina (ex: `http://localhost:5000/usinas/CGH-FAE`)
2. Procure pela ocorr√™ncia rec√©m-criada na "Linha do Tempo: Filtrada"
3. ‚úÖ Deve aparecer um **badge vermelho** com texto "‚ö†Ô∏è REQUER A√á√ÉO"
4. ‚úÖ Deve aparecer um **bot√£o vermelho** "Assumir Responsabilidade"

---

### **3. Testar Bot√£o "Assumir Responsabilidade"**

1. Clique no bot√£o "Assumir Responsabilidade"
2. Confirme a a√ß√£o no popup
3. ‚ö†Ô∏è **NOTA:** A API `/api/ocorrencias/{id}/assumir` ainda **N√ÉO FOI IMPLEMENTADA**
4. Voc√™ receber√° um erro 404 (esperado)

---

## ‚ö†Ô∏è Pr√≥ximos Passos

### **1. Implementar API de "Assumir Responsabilidade"** (Pendente)

**Arquivo a criar:** Adicionar rota em `libs/routes/routes.py`

**C√≥digo sugerido:**
```python
@app.route('/api/ocorrencias/<int:ocorrencia_id>/assumir', methods=['POST'])
def assumir_responsabilidade(ocorrencia_id):
    from libs.controllers.eventosController import EventosController
    controller = EventosController()
    return controller.assumir_responsabilidade(ocorrencia_id)
```

**M√©todo a criar em `eventosController.py`:**
```python
def assumir_responsabilidade(self, ocorrencia_id):
    """Assume responsabilidade de uma ocorr√™ncia"""
    try:
        # Buscar ocorr√™ncia
        ocorrencias_read = Read("op_ocorrencia")
        ocorrencia = ocorrencias_read.find_by_id(ocorrencia_id)
        
        if not ocorrencia:
            return jsonify({"success": False, "error": "Ocorr√™ncia n√£o encontrada"}), 404
        
        # Decodificar metadata
        metadata = json.loads(ocorrencia.get('metadata', '{}'))
        
        # Atualizar respons√°vel (TODO: pegar do usu√°rio logado)
        metadata['responsavel_id'] = 1  # Tempor√°rio
        metadata['assumido_em'] = datetime.now().isoformat()
        
        # Atualizar no banco
        from libs.models.edit import Edit
        edit = Edit("op_ocorrencia")
        result = edit.update(
            where={"id": ocorrencia_id},
            data={"metadata": json.dumps(metadata)}
        )
        
        if result:
            return jsonify({"success": True, "message": "Responsabilidade assumida!"}), 200
        else:
            return jsonify({"success": False, "error": "Erro ao atualizar"}), 500
            
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500
```

---

### **2. Implementar Sistema de Notifica√ß√µes** (Futuro)

- Socket.IO para notifica√ß√µes em tempo real
- Badge de contador no sidebar
- Email/SMS para operadores

---

### **3. Dashboard de Ocorr√™ncias Urgentes** (Futuro)

- Card especial na home mostrando ocorr√™ncias com `requer_acao=True`
- Ordena√ß√£o por prioridade
- Filtro dedicado

---

## üóÑÔ∏è Op√ß√£o: Coluna Dedicada vs JSON

### **Atual (JSON):** ‚úÖ Implementado

**Vantagens:**
- ‚úÖ Flex√≠vel - f√°cil adicionar novos campos
- ‚úÖ N√£o requer migra√ß√£o de schema
- ‚úÖ Extens√≠vel para metadados diversos

**Desvantagens:**
- ‚ùå Mais lento para queries complexas
- ‚ùå Dif√≠cil indexar
- ‚ùå N√£o suporta constraints nativos

---

### **Alternativa (Coluna Dedicada):** (Opcional)

**SQL Migration:**
```sql
-- Adicionar coluna booleana dedicada
ALTER TABLE op_ocorrencia 
ADD COLUMN requer_acao BOOLEAN DEFAULT FALSE AFTER severidade;

-- Criar √≠ndice para performance
CREATE INDEX idx_requer_acao ON op_ocorrencia(requer_acao);

-- Migrar dados existentes (se houver)
UPDATE op_ocorrencia 
SET requer_acao = TRUE 
WHERE JSON_EXTRACT(metadata, '$.requer_acao') = true;
```

**Vantagens:**
- ‚úÖ Queries mais r√°pidas
- ‚úÖ √çndices nativos
- ‚úÖ Constraints e defaults nativos

**Desvantagens:**
- ‚ùå Menos flex√≠vel
- ‚ùå Requer migra√ß√£o de schema
- ‚ùå Precisa modificar c√≥digo para adicionar campos

---

## üìù Checklist de Valida√ß√£o

**Implementa√ß√£o:**
- ‚úÖ Checkbox aparece no formul√°rio
- ‚úÖ JavaScript captura valor
- ‚úÖ Controller salva metadata JSON
- ‚úÖ Badge aparece nas listagens
- ‚úÖ Bot√£o "Assumir" aparece quando necess√°rio
- ‚úÖ Metadata √© decodificado corretamente

**Testes Pendentes:**
- ‚è≥ Salvar ocorr√™ncia com `requer_acao=True`
- ‚è≥ Verificar metadata no banco de dados
- ‚è≥ Confirmar badge vis√≠vel na timeline
- ‚è≥ Confirmar bot√£o vis√≠vel e funcional
- ‚è≥ Implementar API de assumir responsabilidade

---

## üìö Arquivos Modificados

| Arquivo | Altera√ß√µes |
|---------|------------|
| `libs/views/registro_eventos.html` | ‚úÖ Checkbox + JavaScript |
| `libs/controllers/eventosController.py` | ‚úÖ Constru√ß√£o e salvamento de metadata |
| `libs/views/usinas.html` | ‚úÖ Badge + Bot√£o + JavaScript |
| `libs/controllers/usinasController.py` | ‚úÖ Decodifica√ß√£o de metadata |

---

## üéâ Resumo

‚úÖ **Campo "Requer A√ß√£o" est√° 100% implementado no frontend e backend**  
‚úÖ **Salvamento no banco de dados atrav√©s do campo `metadata` JSON**  
‚úÖ **Visualiza√ß√£o com badges e bot√µes funcionais**  
‚è≥ **Aguardando testes do usu√°rio para valida√ß√£o**  
‚è≥ **API de "Assumir Responsabilidade" ser√° implementada ap√≥s testes**

---

**Pr√≥ximo Passo:** Testar o registro de uma ocorr√™ncia com "Requer A√ß√£o" marcado! üöÄ

