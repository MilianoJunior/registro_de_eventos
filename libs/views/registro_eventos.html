{% extends "base.html" %}
{% block title %}Registrar Nova Ocorrência - COG{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/registro_eventos.css') }}">

<div class="content">
    <div class="registro-container">
        <div class="registro-card">
            <h1 class="registro-title">Registrar Nova Ocorrência</h1>
            
            <div class="registro-card-body">
                <form id="formRegistro" class="registro-form">
                <!-- Linha 1: Usina e Operador -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="usina_id" class="form-label">
                            Usina<span class="required">*</span>
                        </label>
                        <select id="usina_id" name="usina_id" class="form-select" required>
                            <option value="">Selecione a usina</option>
                            {% for usina in usinas %}
                            <option value="{{ usina.id }}">{{ usina.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="operador" class="form-label">
                            Operador<span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="operador" 
                            name="operador" 
                            class="form-input" 
                            placeholder="Seu nome"
                            required
                        />
                    </div>
                </div>

                <!-- Linha 2: Tipo e Categoria -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipo" class="form-label">
                            Tipo<span class="required">*</span>
                        </label>
                        <select id="tipo" name="tipo" class="form-select" required>
                            {% for tipo in tipos %}
                            <option value="{{ tipo }}">{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="categoria" class="form-label">
                            Categoria<span class="required">*</span>
                        </label>
                        <select id="categoria" name="categoria" class="form-select" required>
                            {% for categoria in categorias %}
                            <option value="{{ categoria }}">{{ categoria }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Linha 3: Unidade e Tags -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="unidade" class="form-label">
                            Unidade/Sistema<span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="unidade" 
                            name="unidade" 
                            class="form-input" 
                            placeholder="Ex: UG-01, Vertedouro"
                            required
                        />
                    </div>
                    
                    <div class="form-group">
                        <label for="tags" class="form-label">
                            Etiquetas (tags)
                        </label>
                        <input 
                            type="text" 
                            id="tags" 
                            name="tags" 
                            class="form-input" 
                            placeholder="trip, vibração (separado por vírgula)"
                        />
                    </div>
                </div>

                <!-- Seção: Informações e Templates -->
                <div class="info-section">
                    <div class="info-header" onclick="toggleInfoSection()">
                        <svg class="info-icon" width="22" height="22" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span class="info-title">Informações e Templates</span>
                        <svg class="chevron-icon" id="chevronIcon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    
                    <div class="info-content" id="infoContent">
                        <div class="playbook-text">
                            <strong>Playbook:</strong> Documentar manobra, confirmar status dos equipamentos no SCADA.
                        </div>
                        
                        <div class="form-group">
                            <label for="template" class="form-label">
                                Templates de Texto
                            </label>
                            <select id="template" class="form-select" onchange="aplicarTemplate()">
                                <option value="">Selecione um template...</option>
                                {% for template in templates %}
                                <option value="{{ template.id }}" data-texto="{{ template.texto }}">
                                    {{ template.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Descrição Detalhada -->
                <div class="form-group">
                    <label for="descricao" class="form-label">
                        Descrição Detalhada<span class="required">*</span>
                    </label>
                    <textarea 
                        id="descricao" 
                        name="descricao" 
                        class="form-textarea" 
                        rows="6"
                        placeholder="Descreva o evento ou alarme..."
                        required
                    ></textarea>
                </div>

                <!-- Botão de Submissão -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-submit">
                        Registrar Ocorrência
                    </button>
                </div>
            </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle da seção de informações
    function toggleInfoSection() {
        const content = document.getElementById('infoContent');
        const chevron = document.getElementById('chevronIcon');
        content.classList.toggle('expanded');
        chevron.classList.toggle('rotated');
    }

    // Aplicar template selecionado
    function aplicarTemplate() {
        const select = document.getElementById('template');
        const option = select.options[select.selectedIndex];
        const texto = option.getAttribute('data-texto');
        
        if (texto) {
            const descricao = document.getElementById('descricao');
            descricao.value = texto;
            // Adiciona feedback visual
            descricao.style.borderColor = '#3b82f6';
            setTimeout(() => {
                descricao.style.borderColor = '';
            }, 1000);
        }
    }

    // Submissão do formulário
    document.getElementById('formRegistro').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Desabilita o botão durante o envio
        const submitBtn = e.target.querySelector('.btn-submit');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Registrando...';
        submitBtn.style.opacity = '0.7';
        
        const formData = {
            usina_id: parseInt(document.getElementById('usina_id').value),
            operador: document.getElementById('operador').value,
            tipo: document.getElementById('tipo').value,
            categoria: document.getElementById('categoria').value,
            unidade: document.getElementById('unidade').value,
            tags: document.getElementById('tags').value,
            descricao: document.getElementById('descricao').value
        };

        try {
            const response = await fetch('/api/ocorrencias', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                // Feedback visual de sucesso
                submitBtn.textContent = '✓ Registrado com sucesso!';
                submitBtn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                
                // Aguarda 1 segundo antes de redirecionar
                setTimeout(() => {
                    window.location.href = '/';
                }, 1200);
            } else {
                alert('Erro ao registrar ocorrência: ' + result.error);
                // Restaura o botão
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                submitBtn.style.opacity = '1';
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao enviar formulário. Tente novamente.');
            // Restaura o botão
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            submitBtn.style.opacity = '1';
        }
    });

    // Validação em tempo real
    document.querySelectorAll('input[required], select[required], textarea[required]').forEach(field => {
        field.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.style.borderColor = '#ef4444';
            } else {
                this.style.borderColor = '';
            }
        });
        
        field.addEventListener('input', function() {
            if (this.value.trim()) {
                this.style.borderColor = '';
            }
        });
    });
</script>

{% endblock %}

