{% extends "base.html" %}
{% set active_page = "registro_eventos" %}
{% block title %}Registrar Ocorrência — EngeSEP O&M{% endblock %}

{% block content %}
<div class="p-6 space-y-6">
    <h1 class="text-lg font-medium text-text-primary">Registrar Nova Ocorrência</h1>
    
    <form id="form-ocorrencia" class="max-w-[960px] mx-auto space-y-6">
        <!-- Informações Básicas -->
        <div class="bg-surface p-5 rounded-lg border border-slate-200 dark:border-slate-800 space-y-4">
            <h2 class="text-base font-medium text-text-primary mb-3">Informações Básicas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-text-muted uppercase tracking-wide mb-2">Usina*</label>
                    <select id="usina_id" name="usina_id" required class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecione uma usina</option>
                        {% for usina in usinas %}
                        <option value="{{ usina.id }}">{{ usina.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-text-muted uppercase tracking-wide mb-2">Operador*</label>
                    <select id="operador_id" name="operador_id" required class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecione um operador</option>
                        {% for usuario in usuarios %}
                        <option value="{{ usuario.id }}">{{ usuario.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-text-muted uppercase tracking-wide mb-2">Tipo*</label>
                    <select id="tipo" name="tipo" required class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecione um tipo</option>
                        {% for tipo in tipos %}
                        <option value="{{ tipo }}">{{ tipo }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-text-muted uppercase tracking-wide mb-2">Categoria*</label>
                    <select id="categoria" name="categoria" required class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecione uma categoria</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria }}">{{ categoria }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-text-muted uppercase tracking-wide mb-2">Unidade/Sistema*</label>
                    <input type="text" id="unidade" name="unidade" required placeholder="Ex: UG-01, Vertedouro" class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-text-muted uppercase tracking-wide mb-2">Etiquetas (tags)</label>
                    <input type="text" id="tags" name="tags" placeholder="Ex: temperatura, vibração" class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                    <p class="text-xs text-text-muted mt-1">Separe múltiplas tags por vírgula</p>
                </div>
            </div>
        </div>
        
        <!-- Informações e Templates -->
        <div class="bg-surface p-5 rounded-lg border border-slate-200 dark:border-slate-800 space-y-4">
            <h2 class="text-base font-medium text-text-primary mb-2">Informações e Templates</h2>
            <p class="text-sm text-text-muted mb-4">Playbook: Documentar manobra, confirmar status dos equipamentos no SCADA.</p>
            
            <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Template de Texto</label>
                <select id="template_texto" name="template_texto" class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">Selecionar template...</option>
                    {% for template in templates %}
                    <option value="{{ template.id }}" data-texto="{{ template.texto }}">{{ template.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Descrição Detalhada*</label>
                <textarea id="descricao" name="descricao" required rows="6" placeholder="Descreva o evento ou alarme em detalhes..." class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary resize-none"></textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-text-muted uppercase tracking-wide mb-2">Severidade</label>
                    <select id="severidade" name="severidade" class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="baixa">Baixa</option>
                        <option value="média" selected>Média</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-text-muted uppercase tracking-wide mb-2">Playbook</label>
                    <input type="text" id="playbook" name="playbook" placeholder="Referência do playbook" class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-background text-text-primary focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
            </div>
        </div>
        
        <!-- Botões de Ação -->
        <div class="flex justify-end gap-4">
            <a href="{{ url_for('index') }}" class="px-6 py-2 rounded-lg border border-slate-300 dark:border-slate-700 text-text-primary hover:bg-background-alt transition">
                Cancelar
            </a>
            <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium hover:opacity-90 transition flex items-center gap-1.5">
                <span class="material-icons text-base">save</span>
                Registrar Ocorrência
            </button>
        </div>
    </form>
    
    <!-- Mensagem de feedback -->
    <div id="mensagem" class="hidden fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50"></div>
</div>

<script>
    // Preencher textarea com template selecionado
    document.getElementById('template_texto').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const textoTemplate = selectedOption.getAttribute('data-texto');
        if (textoTemplate) {
            document.getElementById('descricao').value = textoTemplate;
        }
    });
    
    // Enviar formulário
    document.getElementById('form-ocorrencia').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            usina_id: document.getElementById('usina_id').value,
            operador_id: document.getElementById('operador_id').value,
            tipo: document.getElementById('tipo').value,
            categoria: document.getElementById('categoria').value,
            unidade: document.getElementById('unidade').value,
            tags: document.getElementById('tags').value,
            template_texto: document.getElementById('template_texto').value,
            descricao: document.getElementById('descricao').value,
            severidade: document.getElementById('severidade').value,
            playbook: document.getElementById('playbook').value
        };
        
        try {
            const response = await fetch('/api/ocorrencias', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            const mensagem = document.getElementById('mensagem');
            if (result.success) {
                mensagem.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-success text-white';
                mensagem.textContent = result.message || 'Ocorrência registrada com sucesso!';
                mensagem.classList.remove('hidden');
                
                // Limpar formulário
                this.reset();
                
                // Redirecionar após 2 segundos
                setTimeout(() => {
                    window.location.href = "{{ url_for('index') }}";
                }, 2000);
            } else {
                mensagem.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-danger text-white';
                mensagem.textContent = result.error || 'Erro ao registrar ocorrência';
                mensagem.classList.remove('hidden');
            }
            
            // Esconder mensagem após 5 segundos
            setTimeout(() => {
                mensagem.classList.add('hidden');
            }, 5000);
            
        } catch (error) {
            const mensagem = document.getElementById('mensagem');
            mensagem.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-danger text-white';
            mensagem.textContent = 'Erro ao conectar com o servidor';
            mensagem.classList.remove('hidden');
            
            setTimeout(() => {
                mensagem.classList.add('hidden');
            }, 5000);
        }
    });
</script>
{% endblock %}
